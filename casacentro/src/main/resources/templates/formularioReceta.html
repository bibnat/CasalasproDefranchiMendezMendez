<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Formulario Receta</title>
    <meta charset="UTF-8">
    <style>
        body {
            font-family: "Segoe UI", sans-serif;
            margin: 30px;
            background-color: #f9f9f9;
        }

        h1, h2, h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .form-section {
            background-color: #fff;
            border: 1px solid #ddd;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        input[type="text"],
        input[type="number"],
        textarea,
        select {
            width: 300px;
            padding: 6px 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        button {
            background-color: #2980b9;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background-color: #1f6391;
        }

        a {
            color: #2980b9;
            text-decoration: none;
            margin-left: 10px;
        }

        a:hover {
            text-decoration: underline;
        }

        .mensaje {
            color: green;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .error {
            color: red;
            font-weight: bold;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>

<h1 th:text="${receta.nombre == null} ? 'Nueva Receta' : 'Editar Receta'">Formulario</h1>

<form th:action="@{/recetas/guardar}" th:object="${receta}" method="post">

    <!-- ⚠️ campo oculto para ID receta (clave para evitar perder datos) -->
    <input type="hidden" th:field="*{id}" />

    <label>Nombre:</label>
    <input type="text" th:field="*{nombre}" required th:readonly="${receta.nombre != null}" /><br/>

    <label>Descripción:</label>
    <textarea th:field="*{descripcion}" required></textarea><br/>

    <div class="form-section">
        <h3>Ingredientes</h3>

        <div id="ingredientes-container">
            <div th:each="ing, iStat : *{ingredientes}">
                <label>Ingrediente:</label>
                <select th:field="*{ingredientes[__${iStat.index}__].ingrediente.id}" required>
                    <option th:each="op : ${ingredientes}"
                            th:value="${op.id}"
                            th:text="${op.nombre}"
                            th:selected="${op.id} == ${ing.ingrediente.id}">
                    </option>
                </select>

                <label>Cantidad (kg):</label>
                <input type="number" step="0.01" th:field="*{ingredientes[__${iStat.index}__].cantidad}" required />

                <label>Calorías:</label>
                <input type="number" th:field="*{ingredientes[__${iStat.index}__].calorias}" required />
                <hr/>
            </div>
        </div>

        <p class="mensaje">
            ¿No encontrás un ingrediente en la lista? Crealo, luego seleccioná "🔄 Recargar" para verlo en el combo.
        </p>

        <button type="button" onclick="recargarIngredientes()">🔄 Recargar ingredientes</button>
        <a th:href="@{/ingredientes/nuevo(recetaId=${receta.id})}" target="_blank">🌱 Crear nuevo ingrediente</a>

        <button type="button" onclick="agregarIngrediente()">➕ Agregar Ingrediente</button>
    </div>

    <button type="submit">💾 Guardar</button>
    <a th:href="@{/recetas}">🔙 Volver</a>
</form>

<!-- Ingrediente template oculto -->
<select id="ingrediente-template" style="display: none;">
    <option th:each="ing : ${ingredientes}" th:value="${ing.id}" th:text="${ing.nombre}"></option>
</select>

<script>
    function agregarIngrediente() {
        const container = document.getElementById("ingredientes-container");
        const index = container.children.length;

        const html = document.createElement("div");

        html.innerHTML = `
            <label>Ingrediente:</label>
            <select name="ingredientes[${index}].ingrediente.id" required>
                ${document.getElementById("ingrediente-template").innerHTML}
            </select>

            <label>Cantidad (kg):</label>
            <input type="number" step="0.01" name="ingredientes[${index}].cantidad" required />

            <label>Calorías:</label>
            <input type="number" name="ingredientes[${index}].calorias" required />
            <hr/>
        `;

        container.appendChild(html);
    }

    function recargarIngredientes() {
        fetch("/ingredientes/opciones") // Corrige esto si cambiaste la ruta
            .then(response => response.text())
            .then(options => {
                const selects = document.querySelectorAll("select[name$='.ingrediente.id']");
                selects.forEach(sel => {
                    const valorAnterior = sel.value;
                    sel.innerHTML = options;
                    sel.value = valorAnterior;
                });
                alert("✅ Ingredientes actualizados en los combos.");
            });
    }
</script>

</body>
</html>
